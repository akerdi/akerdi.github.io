<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>2020-5-11lesson | aKer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Use github package publish dockergitlab.com 网络特别慢，经常 docker push 各种失败. 考虑到github.com 全部免费了，故接下来都转战github 了。(自建是不可能自建的，没有机器) 使用github token 登录(密码登录即将被废弃, 且push、pull 等操作都没有权限)  Go to your GitHub account">
<meta property="og:type" content="article">
<meta property="og:title" content="2020-5-11lesson">
<meta property="og:url" content="https://akerdi.github.io/2020/05/11/2020-5-11lesson/index.html">
<meta property="og:site_name" content="aKer">
<meta property="og:description" content="Use github package publish dockergitlab.com 网络特别慢，经常 docker push 各种失败. 考虑到github.com 全部免费了，故接下来都转战github 了。(自建是不可能自建的，没有机器) 使用github token 登录(密码登录即将被废弃, 且push、pull 等操作都没有权限)  Go to your GitHub account">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2023-03-07T09:24:38.378Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="2020-5-11lesson">
<meta name="twitter:description" content="Use github package publish dockergitlab.com 网络特别慢，经常 docker push 各种失败. 考虑到github.com 全部免费了，故接下来都转战github 了。(自建是不可能自建的，没有机器) 使用github token 登录(密码登录即将被废弃, 且push、pull 等操作都没有权限)  Go to your GitHub account">
  
  <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css">
  <script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', (event) => {
      document.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightBlock(block);
      });
    });
  </script>
  <link rel="stylesheet" href="/css/index.css">
</head>
</html>
<body style="


  background-color: #eff0f6

">
  <div id="container">
    <nav id="nav">
  <header class="header">
    <a href="/" class="title">Clover Tuan</a>
  </header>
  <div class="ctnWrap">
    <div class="icons">
      
        
          
            <a href="https://dribbble.com/clovertuan" target="_blank" class="nav-icn iconfont icon-dribbble"></a>
          
        
          
            <a href="https://www.behance.net/clovertuan" target="_blank" class="nav-icn iconfont icon-behance"></a>
          
        
          
            <a href="http://clovertuan.lofter.com/" target="_blank" class="nav-icn iconfont icon-lofter"></a>
          
        
          
            <a href="https://www.instagram.com/clovertuan/" target="_blank" class="nav-icn iconfont icon-instagram"></a>
          
        
          
            <a href="https://github.com/cloverTuan" target="_blank" class="nav-icn iconfont icon-github"></a>
          
        
      
    </div>
    <div class="menu">
      
        
            <a href="/" class="nav-menu ">HOME</a>
          
        
            <a href="/archives" class="nav-menu ">ARCHIVE</a>
          
        
            <a href="/about" class="nav-menu ">ABOUT</a>
          
        
      
    </div>
  </div>
</nav>
    <div id="main"><section class="article">
  <h2 class="title">2020-5-11lesson</h2>
  <p class="sub">May 11, 2020</p>
  <article class="content">
    <h1 id="Use-github-package-publish-docker"><a href="#Use-github-package-publish-docker" class="headerlink" title="Use github package publish docker"></a>Use github package publish docker</h1><p>gitlab.com 网络特别慢，经常 docker push 各种失败.</p>
<p>考虑到github.com 全部免费了，故接下来都转战github 了。(自建是不可能自建的，没有机器)</p>
<p>使用github token 登录(密码登录即将被废弃, 且push、pull 等操作都没有权限)</p>
<ol>
<li><p>Go to your GitHub account -&gt; Settings -&gt; Developer Settings -&gt; Personal access tokens -&gt; generate new token</p>
</li>
<li><p>Note 选项写上一个标签</p>
</li>
<li><p>勾选 write:packages/read:packages, 然后保存</p>
</li>
<li><p>复制得到的token</p>
</li>
</ol>
<p>docker login docker.pkg.github.com</p>
<p>User: 你的用户名(比如shaohung001)</p>
<p>Password: 第4步得到的token</p>
<h1 id="node-升级package-的库版本"><a href="#node-升级package-的库版本" class="headerlink" title="node 升级package 的库版本"></a>node 升级package 的库版本</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install -g npm-check-updates</span><br><span class="line">ncu -u</span><br></pre></td></tr></table></figure>
<h1 id="Mac-删除node-使用nvm-管理node"><a href="#Mac-删除node-使用nvm-管理node" class="headerlink" title="Mac 删除node, 使用nvm 管理node"></a>Mac 删除node, 使用nvm 管理node</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo npm uninstall npm -g</span><br><span class="line">sudo rm -rf /usr/local/lib/node /usr/local/lib/node_modules /var/db/receipts/org.nodejs.*</span><br><span class="line">sudo rm -rf /usr/local/include/node /Users/$USER/.npm</span><br><span class="line">sudo rm /usr/local/bin/node</span><br><span class="line">sudo rm /usr/local/share/man/man1/node.1</span><br><span class="line">sudo rm /usr/local/lib/dtrace/node.d</span><br></pre></td></tr></table></figure>
<p>下载nvm</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.3/install.sh | bash</span><br><span class="line">或者</span><br><span class="line">wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.3/install.sh | bash</span><br></pre></td></tr></table></figure>
<p>然后在 ~/.bash_profile ~/.zshrc 中加入如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export NVM_DIR=&quot;$HOME/.nvm&quot;</span><br><span class="line">[ -s &quot;$NVM_DIR/nvm.sh&quot; ] &amp;&amp; \. &quot;$NVM_DIR/nvm.sh&quot;  # This loads nvm</span><br><span class="line">[ -s &quot;$NVM_DIR/bash_completion&quot; ] &amp;&amp; \. &quot;$NVM_DIR/bash_completion&quot;  # This loads nvm bash_completion</span><br></pre></td></tr></table></figure>
<pre><code>source ~/.bash_profile &amp;&amp; source ~/.zshrc
</code></pre><p>重开一个terminal 就可以用看到 nvm 命令了</p>
<h1 id="简单探索nodejs-不同第三方库dependence-相同库不同版本"><a href="#简单探索nodejs-不同第三方库dependence-相同库不同版本" class="headerlink" title="简单探索nodejs 不同第三方库dependence 相同库不同版本"></a>简单探索nodejs 不同第三方库dependence 相同库不同版本</h1><p>今天使用puppeteer 和express 时发现，这两个dependence 包含有同一个库: mime。但是express 依赖mime 1.6.4 版本；puppeteer 依赖 2.x 版本；</p>
<p>我们到node_modules 子目录看到第三方库规划: node_modules/mime 是1.6.4，也就是express 依赖的；我们找到puppeteer 下，其提前依赖库本地的mime 2.x 的。</p>
<p>这样，puppeteer 在内部中，require 的是其自身node_modules/mime；express 自身没有node_modules 于是就往上找，也找到对应mime；</p>
<p>以上各自依赖相同库，不同版本，便不会冲突了</p>
<h1 id="mocha-test-时不通过"><a href="#mocha-test-时不通过" class="headerlink" title="mocha test 时不通过"></a>mocha test 时不通过</h1><p>使用mocha test不通过，报错信息:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;before all&quot; hook for &quot;GET /VERSION&quot;:</span><br><span class="line">Error: Timeout of 8000ms exceeded. For async tests and hooks, ensure &quot;done()&quot; is called; if returning a Promise, ensure it resolves. (/builds/xxxxxx/xxxxxx/backend/test/api.test.ts)</span><br></pre></td></tr></table></figure>
<p>说明报错报错信息来源于 beforeAll 方法，且说没有使用done 告知.</p>
<p>原方法：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.beforeAll(<span class="function"><span class="keyword">function</span>(<span class="params">done</span>) </span>&#123;</span><br><span class="line">    app.startup(&#123;testing: <span class="literal">true</span>&#125;, <span class="function">(<span class="params">_server: Express.Application</span>) =&gt;</span> &#123;</span><br><span class="line">        server = _server</span><br><span class="line">        done()</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>明显是有done 这个操作的，难道throw error 导致没有进入done 了？？那我加个try catch 吧:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.beforeAll(<span class="function"><span class="keyword">function</span>(<span class="params">done</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        app.startup(&#123;testing: <span class="literal">true</span>&#125;, <span class="function">(<span class="params">_server: Express.Application</span>) =&gt;</span> &#123;</span><br><span class="line">        server = _server</span><br><span class="line">        done()</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        done(error)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><del>然后gitlab-ci 看到编译正常通过了, 但是没有进catch, 因为进了catch 我接下来拿不到server， 但之后又正常，说明只是说，要有try catch 确保有done 回馈即可!</del></p>
<p>以上. node -v : <code>v10.20.1</code></p>
<p>这里更新下：</p>
<p>上面有时可以有时失败，说明不是最终原因. 以下是最终原因</p>
<p>最终的原因是gitlab-ci cpu、memory 太低，运行太慢，导致获取到server 太慢，无法得到done，做法是<code>mocha -t 240000</code> 设置4分钟.</p>
<p>这个原因也是没有预料到，没想到是机器配置比较低的原因。</p>

  </article>
  <footer class="f-cf">
    
      <a href="/2020/05/11/2020-5-12lesson/" class="link f-fl">⟵2020-5-12lesson</a>
    
    
      <a href="/2020/04/16/2020-4-16lesson/" class="link f-fr">2020-4-16lesson⟶</a>
    
  </footer>
</section></div>
    <footer id="footer" class="f-cf">
  d.guangying@foxmail.com
  
    
      
        · <a href="https://dribbble.com/clovertuan" target="_blank" class="nav-icn">Dribbble</a>
      
    
      
        · <a href="https://www.behance.net/clovertuan" target="_blank" class="nav-icn">Behance</a>
      
    
      
        · <a href="http://clovertuan.lofter.com/" target="_blank" class="nav-icn">Lofter</a>
      
    
      
        · <a href="https://www.instagram.com/clovertuan/" target="_blank" class="nav-icn">Instagram</a>
      
    
      
        · <a href="https://github.com/cloverTuan" target="_blank" class="nav-icn">GitHub</a>
      
    
  
  <span class="copyright">All rights reserved @Clover Tuan</span>
</footer>
  </div>
</body>
</html>